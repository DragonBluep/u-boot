bootdev=nor
baudrate=115200
loadaddr=50000000
ipaddr=192.168.1.1
serverip=192.168.1.254
ethaddr=aa:bb:cc:dd:ee:ff
file_bl2=preloader.bin
file_fip=bl31-uboot.fip
file_fw=firmware.itb
file_ik=initramfs-kernel.bin
file_img=emmc.img
bootargs=root=/dev/fit0 rootwait
bootcmd=test x$bootdev = xmmc && run mmc_read_fw && bootm $loadaddr$bootconf_mmc; run nor_read_fw && bootm $loadaddr
bootconf_mmc=#config-1#mt7981b-siluo-sl-3000-emmc
bootmenu_0=[36m[1mExec default boot command[0m=run bootcmd; echo [31m[1mBoot failed![0m; sleep 3; reset
bootmenu_1=[36m[1mBoot system from Flash[0m=run bootcmd; echo [31m[1mBoot failed![0m; pause; bootmenu 60
bootmenu_2=[32m[1mLoad initramfs image via TFTP then boot[0m=run tftp_boot_ik; pause; bootmenu 60
bootmenu_3=[32m[1mLoad system via TFTP then write to Flash[0m=run tftp_update_fw; pause; bootmenu 60
bootmenu_4=[33m[1mLoad BL2 via TFTP then write to Flash[0m=run tftp_update_bl2; pause; bootmenu 60
bootmenu_5=[33m[1mLoad FIP via TFTP then write to Flash[0m=run tftp_update_fip; pause; bootmenu 60
bootmenu_6=[34m[1mSwitch boot device[0m=run switch_bootdev; pause; bootmenu 60
bootmenu_7=[35m[1mReboot[0m=reset
check_bl2_integrity=if run md5_verify_bl2; then echo [31m[1mBL2 upgrade successful![0m; else echo [31m[1mBL2 upgrade failed![0m; fi
check_fip_integrity=if run md5_verify_fip; then echo [31m[1mFIP upgrade successful![0m; else echo [31m[1mFIP upgrade failed![0m; fi
continue_or_not=askenv token [31m[1mContinue? [Y/n][0m 1 && char=$token && setenv token; test x$char = xy || test x$char = xY
initcmd=run set_macaddr && setenv set_macaddr && setenv initcmd
md5_verify_bl2=md5sum $loadaddr $filesize sum && hash=$sum && setenv sum && mtd read bl2 $loadaddr && md5sum -v $loadaddr $filesize $hash
md5_verify_fip=md5sum $loadaddr $filesize sum && hash=$sum && setenv sum && mtd read fip $loadaddr && md5sum -v $loadaddr $filesize $hash
mmc_prep_write=setexpr ioblks $filesize + 1ff && setexpr ioblks $ioblks / 200
mmc_read_fw=run mmc_seek_fit && mmc read $loadaddr $fitaddr 100 && imszb $loadaddr ioblks && mmc read $loadaddr $fitaddr $ioblks && setenv ioblks
mmc_seek_fit=part start mmc 0 fit voladdr && fitaddr=$voladdr && setenv voladdr
mmc_write_fw=run mmc_seek_fit && run mmc_prep_write && mmc write $loadaddr $fitaddr $ioblks && setenv ioblks
nor_prep_erase=setexpr iosize $filesize + ffff && setexpr iosize $iosize / 10000 && setexpr iosize $iosize * 10000
nor_read_fw=mtd read firmware $loadaddr 0 10000 && imsz $loadaddr iosize && mtd read firmware $loadaddr 0 $iosize && setenv iosize
nor_write_fw=run nor_prep_erase && mtd erase firmware 0 $iosize && setenv iosize && mtd write firmware $loadaddr 0 $filesize
set_macaddr=mtd read factory $loadaddr && setexpr ptr $loadaddr + 0004 && readmem -b ethaddr $ptr && setenv ptr
setup_netcon=setenv ncip $serverip && setenv stdin nc && setenv stdout nc && setenv stderr nc
setup_uartcon=setenv stderr serial@11002000 && setenv stdout serial@11002000 && setenv stdin serial@11002000 && setenv ncip
switch_bootdev=if test x$bootdev = xmmc; then setenv bootdev nor && echo [31m[1mNOR selected![0m; else setenv bootdev mmc && echo [31m[1mMMC selected![0m; fi && saveenv
switch_console=if test x$stdin = xnc; then run setup_uartcon && setenv bootdelay; else run setup_netcon && setenv bootdelay 60; fi
tftp_boot_ik=test x$bootdev = xmmc && conf=$bootconf_mmc || conf=; while true; do tftpboot $loadaddr $file_ik && bootm $loadaddr$conf; sleep 3; done
tftp_update_bl2=tftpboot $loadaddr $file_bl2 && run continue_or_not && mtd erase bl2 && mtd write bl2 $loadaddr 0 $filesize && run check_bl2_integrity
tftp_update_fip=tftpboot $loadaddr $file_fip && run continue_or_not && mtd erase fip && mtd write fip $loadaddr 0 $filesize && run check_fip_integrity
tftp_update_fw=while true; do run tftp_write_fw && run bootcmd; run tftp_write_img && run bootcmd; sleep 3; done
tftp_write_fw=tftpboot $loadaddr $file_fw && if test x$bootdev = xmmc; then run mmc_write_fw; else run nor_write_fw; fi
tftp_write_img=tftpboot $loadaddr $file_img && run mmc_prep_write && mmc write $loadaddr 0 $ioblks && setenv ioblks
